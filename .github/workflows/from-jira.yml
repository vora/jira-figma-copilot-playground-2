name: Jira â†’ Feature Generator

on:
  repository_dispatch:
    types: [jira_issue_ready_for_dev]

jobs:
  generate_feature:
    runs-on: ubuntu-latest
    env:
      JIRA_WEBHOOK_SECRET: ${{ secrets.JIRA_WEBHOOK_SECRET }}
      FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Validate incoming webhook signature
        run: |
          echo "Webhook payload: $GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Extract issue and figma data
        id: extract
        run: |
          ISSUE_KEY=$(jq -r .client_payload.issueKey < "$GITHUB_EVENT_PATH")
          SUMMARY=$(jq -r .client_payload.summary < "$GITHUB_EVENT_PATH")
          DESCRIPTION=$(jq -r .client_payload.description < "$GITHUB_EVENT_PATH")
          FIGMA_URL=$(jq -r .client_payload.figma_link < "$GITHUB_EVENT_PATH")
          {
          echo "issue_key=$ISSUE_KEY"
          echo "figma_url=$FIGMA_URL"
          echo "summary<<EOF"
          echo "$SUMMARY"
          echo "EOF"
          echo "description<<EOF"
          echo "$DESCRIPTION"
          echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Figma file metadata
        id: figma
        run: |
          FILE_ID=$(echo "${{ steps.extract.outputs.figma_url }}" | sed -E 's|https://www.figma.com/file/([^/?]+).*|\1|')
          curl -H "X-Figma-Token: $FIGMA_TOKEN" \
               "https://api.figma.com/v1/files/$FILE_ID" \
               -o figma-data.json
          echo "figma_file_id=$FILE_ID" >> $GITHUB_OUTPUT

      - name: Create workspace payload
        id: payload
        run: |
          cat <<EOF > workspace-payload.json
          {
            "issueKey": "${{ steps.extract.outputs.issue_key }}",
            "summary": "${{ steps.extract.outputs.summary }}",
            "description": "${{ steps.extract.outputs.description }}",
            "figmaFileId": "${{ steps.figma.outputs.figma_file_id }}",
            "figmaMetadata": $(jq -c . < figma-data.json)
          }
          EOF

      - name: Generate modal via Anthropic
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Escape values for JSON (handle quotes and newlines)
          DESCRIPTION=$(jq -Rs . <<< "${{ steps.extract.outputs.description }}")
          FIGMA_URL="${{ steps.extract.outputs.figma_url }}"
          
          # Create the request payload
          PAYLOAD=$(jq -n \
            --arg desc "${{ steps.extract.outputs.description }}" \
            --arg figma "$FIGMA_URL" \
            '{
              model: "claude-sonnet-4-20250514",
              max_tokens: 4096,
              temperature: 0.2,
              messages: [{
                role: "user",
                content: ("Write a React TypeScript modal component for the following Jira description:\n" + $desc + "\nFigma link: " + $figma)
              }]
            }')
          
          # Make the API call
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$PAYLOAD")
          
          # Create directory if it doesn't exist
          mkdir -p src/components
          
          # Extract and save the generated code
          echo "$RESPONSE" | jq -r '.content[0].text' > src/components/GeneratedModal.tsx
          
          # Debug: Show what was generated
          echo "Generated file contents:"
          cat src/components/GeneratedModal.tsx

      - name: Create feature branch & PR
        run: |
          # Set variables from previous step outputs
          ISSUE_KEY="${{ steps.extract.outputs.issue_key }}"
          SUMMARY="${{ steps.extract.outputs.summary }}"
          BRANCH="feat/$ISSUE_KEY"

          echo "Creating branch: $BRANCH"

          # Configure Git author (required on GitHub Actions runner)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create new branch
          git checkout -b "$BRANCH"

          # Check what files are being added
          echo "Files to be committed:"
          git status

          # Add all generated files
          git add src/components/GeneratedModal.tsx workspace-payload.json figma-data.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 1
          fi

          # Commit with proper message
          git commit -m "feat($ISSUE_KEY): generated feature from Copilot"

          # Push branch
          git push --set-upstream origin "$BRANCH"

          # Open PR via GitHub CLI
          gh pr create \
            --title "Feature $ISSUE_KEY: $SUMMARY" \
            --body "Auto-generated scaffold from Copilot for Jira issue $ISSUE_KEY" \
            --base main
