name: Jira â†’ Feature Generator

on:
  repository_dispatch:
    types: [jira_issue_ready_for_dev]

jobs:
  generate_feature:
    runs-on: ubuntu-latest
    env:
      JIRA_WEBHOOK_SECRET: ${{ secrets.JIRA_WEBHOOK_SECRET }}
      FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Validate incoming webhook signature
        # (You should implement verification of JIRA_WEBHOOK_SECRET if desired)
        run: |
          echo "Webhook payload: $GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      
      - name: Extract issue and figma data
        id: extract
        run: |
          ISSUE_KEY=$(jq -r .client_payload.issueKey < "$GITHUB_EVENT_PATH")
          SUMMARY=$(jq -r .client_payload.summary < "$GITHUB_EVENT_PATH")
          DESCRIPTION=$(jq -r .client_payload.description < "$GITHUB_EVENT_PATH")
          FIGMA_URLS=$(jq -r .client_payload.figmaUrls[] < "$GITHUB_EVENT_PATH")
          echo "::set-output name=issue_key::$ISSUE_KEY"
          echo "::set-output name=summary::$SUMMARY"
          echo "::set-output name=description::$DESCRIPTION"
          echo "::set-output name=figma_urls::$FIGMA_URLS"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Figma file metadata
        id: figma
        run: |
          FILE_ID=$(echo "${{ steps.extract.outputs.figma_urls }}" | sed -E 's|https://www.figma.com/file/([^/?]+).*|\1|')
          curl -H "X-Figma-Token: $FIGMA_TOKEN" \
               "https://api.figma.com/v1/files/$FILE_ID" \
               -o figma-data.json
          echo "::set-output name=figma_file_id::$FILE_ID"

      - name: Create workspace payload
        id: payload
        run: |
          cat <<EOF > workspace-payload.json
          {
            "issueKey": "${{ steps.extract.outputs.issue_key }}",
            "summary": "${{ steps.extract.outputs.summary }}",
            "description": "${{ steps.extract.outputs.description }}",
            "figmaFileId": "${{ steps.figma.outputs.figma_file_id }}",
            "figmaMetadata": $(jq . < figma-data.json)
          }
          EOF

      - name: Call Copilot Workspace API
        id: copilot
        run: |
          echo "Calling Copilot Workspace..."
          curl -X POST \
               -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Content-Type: application/json" \
               -d @workspace-payload.json \
               https://api.github.com/repos/${{ github.repository }}/actions/copilot/workspaces

      - name: Create feature branch & PR (optional)
        # You could script branch creation, commit autogenerated files, push, and open PR
        run: |
          BRANCH="feat/${{ steps.extract.outputs.issue_key }}"
          git checkout -b $BRANCH
          # assume Copilot workspace has produced files in working directory
          git add .
          git commit -m "feat(${ { steps.extract.outputs.issue_key } }): generated feature from Copilot"
          git push --set-upstream origin $BRANCH
          # open PR via GitHub CLI
          gh pr create --title "Feature ${ { steps.extract.outputs.issue_key } }: $SUMMARY" \
                       --body "Auto-generated scaffold from Copilot for Jira issue ${{ steps.extract.outputs.issue_key }}" \
                       --base main
