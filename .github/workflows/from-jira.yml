name: Jira â†’ Feature Generator

on:
  repository_dispatch:
    types: [jira_issue_ready_for_dev]

jobs:
  generate_feature:
    runs-on: ubuntu-latest
    env:
      JIRA_WEBHOOK_SECRET: ${{ secrets.JIRA_WEBHOOK_SECRET }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Validate incoming webhook payload
        run: |
          echo "Webhook payload: $GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

      - name: Extract issue and figma data
        id: extract
        run: |
          ISSUE_KEY=$(jq -r .client_payload.issueKey < "$GITHUB_EVENT_PATH")
          SUMMARY=$(jq -r .client_payload.summary < "$GITHUB_EVENT_PATH")
          DESCRIPTION=$(jq -r .client_payload.description < "$GITHUB_EVENT_PATH")
          FIGMA_URL=$(jq -r .client_payload.figma_link < "$GITHUB_EVENT_PATH")
          echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV
          echo "DESCRIPTION=$DESCRIPTION" >> $GITHUB_ENV
          echo "FIGMA_URL=$FIGMA_URL" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate React modal via Anthropic
        id: generate_modal
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DESCRIPTION: ${{ env.DESCRIPTION }}
          FIGMA_URL: ${{ env.FIGMA_URL }}
        run: |
          RESPONSE=$(curl https://api.anthropic.com/v1/complete \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANTHROPIC_API_KEY" \
            -d '{
              "model": "claude-2",
              "prompt": "Write a React TypeScript modal component based on the following Jira description:\n'"$DESCRIPTION"'\nFigma link: '"$FIGMA_URL"'",
              "max_tokens_to_sample": 2000,
              "temperature": 0.2
            }')

          echo "$RESPONSE" | jq -r '.completion' > src/components/GeneratedModal.tsx
          echo "Generated modal component at src/components/GeneratedModal.tsx"

      - name: Create feature branch & PR
        env:
          ISSUE_KEY: ${{ env.ISSUE_KEY }}
          SUMMARY: ${{ env.SUMMARY }}
        run: |
          BRANCH="feat/$ISSUE_KEY"

          echo "Creating branch: $BRANCH"

          # Configure Git author
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create new branch
          git checkout -b "$BRANCH"

          # Add generated modal
          git add src/components/GeneratedModal.tsx

          # Commit
          git commit -m "feat($ISSUE_KEY): generated modal from Anthropic"

          # Push branch
          git push --set-upstream origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "Feature $ISSUE_KEY: $SUMMARY" \
            --body "Auto-generated modal component from Anthropic for Jira issue $ISSUE_KEY" \
            --base main
